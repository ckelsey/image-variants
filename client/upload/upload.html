<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Image variants upload test</title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width">
	<style>
		html {
			background-color: #eee;
			color: #555;
		}

		body {
			font-family: sans-serif;
			margin: 0px;
		}

		img {
			width: 70px;
			vertical-align: middle;
			display: inline-block;
			margin: 0px 7px;
		}

		p {
			font-size: 12px;
		}

		#canvas_outer {
			width: 100vw;
			height: 70vh;
			max-width: 100%;
			position: relative;
		}

		#canvas_wrapper {
			width: 100%;
			height: 100%;
		}

		#ckropper{
			width: 100%;
			height: 100%;
			position: absolute;
			top: 0px;
			left: 0px;
		}
	</style>
</head>

<body>
	<div id="canvas_outer">
		<div id="canvas_wrapper"></div>
	</div>
	<div>
		<input type="file" id="file_input" style="background: #fff; padding: 7px;">
		<span id="status"></span>
		<button id="upload" style="display: none;">Upload</button>
	</div>
	<div id="dimensions" style="display: none; align-items: center; justify-content: space-evenly; background: #dcdcdc;">
		<p>Pan:
			<b id="pan"></b>
		</p>
		<p>Tilt:
			<b id="tilt"></b>
		</p>
		<p>Zoom:
			<b id="zoom"></b>
		</p>
		<p>Source width:
			<b id="source_width"></b>
		</p>
		<p>Source height:
			<b id="source_height"></b>
		</p>
		<p>View width:
			<b id="view_width"></b>
		</p>
		<p>View height:
			<b id="view_height"></b>
		</p>
		<p>X1:
			<b id="x1">10%</b>
		</p>
		<p>X2:
			<b id="x2">10%</b>
		</p>
		<p>Y1:
			<b id="y1">10%</b>
		</p>
		<p>Y2:
			<b id="y2">10%</b>
		</p>
	</div>
	<div id="images" style="display: none; align-items: center; justify-content: space-evenly">
		<p>Large:
			<span id="large_url"></span>
		</p>
		<p>Small:
			<span id="small_url"></span>
		</p>
		<p>Thumb:
			<span id="thumb_url"></span>
		</p>
	</div>
	<script src="/uploadjs/promise.polyfill.js"></script>
	<script src="/uploadjs/getThis.js"></script>

	<script src="/uploadjs/viewer/lib/webvr-polyfill.js"></script>
	<script src="/uploadjs/viewer/lib/gl-matrix-min.js"></script>
	<script src="/uploadjs/viewer/lib/wglu-program.js"></script>
	<script src="/uploadjs/viewer/lib/vr-panorama.js"></script>
	<script src="/uploadjs/viewer/lib/three.min.js"></script>
	<script src="/uploadjs/viewer/lib/device-controls.js"></script>
	<script src="/uploadjs/viewer/lib/fabric.min.js"></script>

	<script src="/uploadjs/viewer/draw2d.js"></script>
	<script src="/uploadjs/viewer/draw3d.js"></script>
	<script src="/uploadjs/viewer/draw360.js"></script>
	<script src="/uploadjs/viewer/draw-vr.js"></script>

	<script src="/uploadjs/meta/lib/exif.js"></script>
	<script src="/uploadjs/meta/lib/png.js"></script>
	<script src="/uploadjs/meta/getMeta.js"></script>


	<script src="/uploadjs/upload/image-reader.js"></script>
	<script src="/uploadjs/upload/ckropper.js"></script>
	<script src="/uploadjs/upload/uploader.js"></script>


	<script>
		var input = document.getElementById("file_input")
		var uploadBtn = document.getElementById("upload")
		var large = document.getElementById("large_url")
		var small = document.getElementById("small_url")
		var thumb = document.getElementById("thumb_url")
		var statusMessage = document.getElementById("status")
		var panText = document.getElementById("pan")
		var tiltText = document.getElementById("tilt")
		var zoomText = document.getElementById("zoom")
		var sourceWidthText = document.getElementById("source_width")
		var sourceHeightText = document.getElementById("source_height")
		var viewWidthText = document.getElementById("view_width")
		var viewHeightText = document.getElementById("view_height")
		var x1Text = document.getElementById("x1")
		var x2Text = document.getElementById("x2")
		var y1Text = document.getElementById("y1")
		var y2Text = document.getElementById("y2")
		var dimensions = document.getElementById("dimensions")
		var images = document.getElementById("images")
		var x1 = 10, x2 = 10, y1 = 10, y2 = 10, sourceHeight,sourceWidth,viewHeight,viewWidth,pan,tilt,zoom

		function drawCanvas(file) {

			images.style.display = "none"
			statusMessage.textContent = "Getting metadata"

			getMetadata(file).then(function (meta) {

				statusMessage.textContent = "Drawing"
				var method = null
				var canvasWrapper = document.getElementById("canvas_wrapper")
				var new_canvasWrapper = canvasWrapper.cloneNode(true);
				canvasWrapper.parentNode.replaceChild(new_canvasWrapper, canvasWrapper);

				if (meta["360"]) {
					method = draw360(file, new_canvasWrapper)
				} else if (meta["3d"]) {
					method = draw3D(file, new_canvasWrapper, true)
				} else {
					method = draw2D(file, new_canvasWrapper, true)
				}

				method.then(function (onUpdate) {

					statusMessage.textContent = ""
					uploadBtn.style.display = "inline"
					dimensions.style.display = "flex"

					onUpdate(function (data) {

						pan = panText.textContent = data.pan.toFixed(2)
						tilt = tiltText.textContent = data.tilt.toFixed(2)
						zoom = zoomText.textContent = data.zoom.toFixed(2)
						sourceHeight = sourceHeightText.textContent = Math.round(data.sourceHeight)
						sourceWidth = sourceWidthText.textContent = Math.round(data.sourceWidth)
						viewHeight = viewHeightText.textContent = Math.round(data.viewHeight)
						viewWidth = viewWidthText.textContent = Math.round(data.viewWidth)
					})

					ckropper.init(document.querySelector("#canvas_wrapper canvas"), {
						minWidth: 300,
						minHeight: 100
					})

					ckropper.onUpdate(function (data) {
						x1 = data.x1
						x2 = data.x2
						y1 = data.y1
						y2 = data.y2
						x1Text.textContent = data.x1.toFixed(2) + "%"
						x2Text.textContent = data.x2.toFixed(2) + "%"
						y1Text.textContent = data.y1.toFixed(2) + "%"
						y2Text.textContent = data.y2.toFixed(2) + "%"
					})

					ckropper.show()
				})
			}, function () {

				statusMessage.textContent = "Not a valid GeForce image"
				uploadBtn.style.display = "none"
				dimensions.style.display = "none"
				input.value = null
			})
		}

		input.addEventListener("change", function () {

			drawCanvas(this.files[0])
		}, false)

		uploadBtn.addEventListener("click", function () {
			uploadBtn.style.display = "none"

			upload(input.files[0], {

				x1, x2, y1, y2,
				sourceHeight,sourceWidth,
				viewHeight, viewWidth,
				pan, tilt, zoom

			}, function (uploaded) {

				statusMessage.textContent = "Uploading " + uploaded + "%"

			}).then(function (res) {

				statusMessage.textContent = ""
				uploadBtn.style.display = "none"
				images.style.display = "flex"
				large.innerHTML = `<a target="_blank" href="` + res.result.urls.large + `"><img src="` + res.result.urls.large + `"></a>`
				small.innerHTML = `<a target="_blank" href="` + res.result.urls.small + `"><img src="` + res.result.urls.small + `"></a>`
				thumb.innerHTML = `<a target="_blank" href="` + res.result.urls.thumb + `"><img src="` + res.result.urls.thumb + `"></a>`

			}, function (err) {

				uploadBtn.style.display = "none"
				statusMessage.textContent = "Error " + JSON.stringify(err)

			})
		}, false)

	</script> </body>

</html>